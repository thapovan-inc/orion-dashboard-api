<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Orion - Tracing tool</title>
  <link type="text/css" rel="stylesheet" href="css/Roboto.css" media="all" />
  <link type="text/css" rel="stylesheet" href="css/orion.css" media="all" />
  <link type="text/css" rel="stylesheet" href="css/jquery.jsonview.css" media="all" />
</head>

<body>
  <div id="orion">
    <header>
      <div class="left-col">
        <div class="logo">
          <div class="orion-logo">Orion
            <span>Tracing tool</span>
          </div>
        </div>
      </div>
      <div class="right-col">
        <div class="user-details">
          <div class="user-info">
            <p>Welcome Vaidy!</p>
            <p>Monday, 10th May</p>
          </div>
          <div class="thumb">
            <img src="images/avatar.png" alt="Vaidy" />
          </div>
        </div>
        <div class="search-container">
          <div class="search">
            <input type="text" name="search" name="search" placeholder="Lookup by Trace ID..." v-model="keyword" v-bind:class="{ error : isKeywordError}"
              @keyup.enter="search()" :readonly="isKeywordLoading" />
            <a href="javascript:void(0)" class="icon-search"></a>
          </div>
        </div>
      </div>
    </header>
    <!-- end header -->
    <div id="content">
      <div id="dashboard">
        <div id="search-section">
          <div class="page-title">
            <h2>
              <i class="icon-dashboard"></i> Dashboard</h2>
          </div>
          <div class="search-filters">
            <div class="label">Filter By</div>
            <div class="checkbox">
              <input name="filterby" id="passed" type="checkbox">
              <label for="passed">Passed</label>
            </div>
            <div class="checkbox">
              <input name="filterby" id="slow" type="checkbox">
              <label for="slow">Slow</label>
            </div>
            <div class="checkbox">
              <input name="filterby" id="failed" type="checkbox">
              <label for="failed">Failed</label>
            </div>
            <div class="form-group">
              <input type="text" name="location" value="Location" />
              <input type="text" name="ip" value="IP" />
              <input type="text" name="date" value="Date" />
            </div>
          </div>
        </div>

        <div class="main-wrapper">
          <section id="charts">
            <canvas id="livefeed" style="height:400px !important;" v-on:click="getAccordionDetails">

            </canvas>
          </section>
          <section id="breadcrumbs">
            <div class="status" v-for="service in api">
              <ul class="breadcrumb">
                <li>
                  <a href="#">{{ service.apiName}}</a>
                </li>
                <li class="success">
                  <a href="#" v-on:click="getPass(service)">{{ service.passCount}}</a>
                </li>
                <li class="warning">
                  <a href="#" v-on:click="getFail(service)">{{ service.slowCount}}</a>
                </li>
                <li class="error">
                  <a href="#" v-on:click="getError(service)">{{ service.failCount}}</a>
                </li>
              </ul>
            </div>
          </section>
          <section id="trace-details" style="display:none;">
            <ul>
              <li>
                <span>Trace Name:</span>
                <span>{{ traceName }}</span>
              </li>
              <li>
                <span>Trace ID:</span>
                <span>{{ traceId }}</span>
              </li>
              <li>
                <span>Start Time:</span>
                <span>{{ startTime }}</span>
              </li>
              <li>
                <span>End Time:</span>
                <span>{{ endTime }}</span>
              </li>
              <li>
                <span>Duration:</span>
                <span>{{ duration }} ms</span>
              </li>
            </ul>
          </section>
          <section>
            <div class="accordion">
              <div class="accordion-panel" v-for="(value, key) in requestInfo" v-if="key != 'ROOT'">
                <a :class="['accordion-title toggle collapse ' + value.status]" :id="['span_'+ key]" href="javascript:void(0);" @click="jsonPass(key,value)">
                    {{ value.serviceName }}                 
                    <span>Duration:{{ value.duration}} ms</span>                   
                </a>
                <div class="accordion-content" :id="value.spanId">
                </div>
              </div>
            </div>
          </section>

          <!-- <section class="accordion-section">
            <ul class="accordion">
                            <li class="span" v-for="(value, key) in requestInfo" v-if="key != 'ROOT'">
                <a :class="['span toggle collapse ' + status]" :id="['span_'+ key]" href="javascript:void(0);" @click="jsonPass(key,value)">
                  <pre>{{ value.serviceName }}                 Duration:{{ value.duration}}</pre>
                </a>
                <div :id="value.spanId" class="json-data inner">

                </div>
              </li>
            </ul>
          </section> -->
        </div>
      </div>
    </div>
    <!-- end content -->
    <footer>
      <p>Copyright &copy; 2018 Thapovan Info Systems, Inc. All rights reserved.</p>
    </footer>
  </div>

  <script type="text/javascript" src="js/Chart.bundle.min.js"></script>
  <script type="text/javascript" src="js/jquery-3.2.1.js"></script>
  <script type="text/javascript" src="/public/javascript/jquery.jsonview.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script type="text/javascript" src="/public/javascript/ActionheroWebsocketClient.min.js"></script>
  <script type="text/javascript">
    var app = new Vue({
      el: '#orion',
      data: {
        serviceName: null,
        traceId: null,
        traceName: null,
        model: null,
        phoneType: null,
        brand: null,
        screenSize: null,
        androidVersion: null,
        location: null,
        status: 'success',
        myScatter: null,
        accodion: {
          data: []
        },
        trace: '',
        device: '',
        keyword: '',
        service: '',
        api: {},
        isKeywordError: '',
        isKeywordLoading: false,
        requestInfo: {},
        jsonView: {},
        startTime: '',
        endTime: '',
        duration: ''
      },
      methods: {
        getAccordionDetails: function (event) {
          $("#trace-details").hide();
          $(".accordion").hide();
          var activePoints = this.myScatter.getElementsAtEvent(event);
          var firstPoint = activePoints[0];
          if(firstPoint !== undefined) {
          value = this.myScatter.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
          //        console.log(JSON.stringify(value));
          this.traceId = value.traceId;
          this.traceName = value.traceName;
          this.duration = value.duration;
          this.startTime = value.startTime;
          this.endTime = value.endTime;
          var self = this;
          axios.get('/api', {
              params: {
                action: 'getTraceById',
                traceId: this.traceId //pass static id here
              }
            })
            .then(function (response) {
              //console.log('responce=' + JSON.stringify(response));
              var temptraceId = this.traceId;
              var life_cycle_json = response.data.result.data.life_cycle_json.spanList;
              $("#trace-details").show();
              $(".accordion").show();
              // console.log('lifecycle=' + JSON.stringify(life_cycle_json));
              //            for (var key in life_cycle_json) {
              //              if (life_cycle_json.hasOwnProperty(key)) {
              //                var val = life_cycle_json[key];
              //                delete key.children;
              //                delete key.events;
              //              }
              //            }
              //            self.deviceInfo=response.data.result.data;
              //            self.lifeCycle=response.data.result.data.lifeCycle;
              self.requestInfo = life_cycle_json;
              //            this.$nextTick(function () {
              //              console.log(this.$el.textContent) // => 'updated'
              //            })
              // console.log(" responce= " + JSON.stringify(response.data.result));
              //            var requestStatus = response.data.result.data[0].status;
              //            if(requestStatus == 'FAIL')
              //            {
              //              self.status = 'error';
              //            }
              //            else if( requestStatus == 'PASS'){
              //              self.status = 'success';
              //            }
              //            else {
              //              self.status = 'success';
              //            }
              //            self.model=response.data.result.data[0].deviceInfo.model;
              //            self.phoneType= response.data.result.data[0].deviceInfo.phoneType;
              //            self.brand= response.data.result.data[0].deviceInfo.brand;
              //            self.screenSize= response.data.result.data[0].deviceInfo.screenSize;
              //            self.androidVersion= response.data.result.data[0].deviceInfo.androidversion;
              //            self.location= response.data.result.data[0].location;
              //            console.log(response.data.result);
              //            console.log(" responce= " + JSON.stringify(response));
            })
            .catch(function (error) {
              console.log(error);
            });
          }
        },
        jsonPass(key, value) {
          if ($("#span_" + key).hasClass('collapse')) { //expand the li and showsss
            $("#span_" + key).parent().parent().find('.toggle').addClass("collapse").removeClass("expand");
            $('.accordion-content').removeClass("show").hide();
            $("#span_" + key).addClass('expand').removeClass('collapse');
            $("#span_" + key).next().addClass('show');
            $("#span_" + key).next().slideDown(350);
          } else { //closing here
            $("#span_" + key).addClass('collapse').removeClass('expand');
            $("#span_" + key).next().removeClass('show');
            $("#span_" + key).next().slideUp(350);
          }
          $("#" + value.spanId).JSONView(JSON.stringify(value));
        },
        getPass(service) {

          axios.get('/api', {
              params: {
                action: 'getTraceById',
                apiName: service.apiName,
                status: 'PASS',
              }
            })
            .then(function (response) {
              self.serviceName = response.data.result.data[0].lifeCycle[0].serviceName;
              // console.log(" responce= " + JSON.stringify(response.data.result));
              self.traceId = response.data.result.data[0].traceId;
              var requestStatus = response.data.result.data[0].status;
              if (requestStatus == 'FAIL') {
                self.status = 'error';
              } else if (requestStatus == 'PASS') {
                self.status = 'success';
              } else {
                self.status = 'success';
              }
              self.model = response.data.result.data[0].deviceInfo.model;
              self.phoneType = response.data.result.data[0].deviceInfo.phoneType;
              self.brand = response.data.result.data[0].deviceInfo.brand;
              self.screenSize = response.data.result.data[0].deviceInfo.screenSize;
              self.androidVersion = response.data.result.data[0].deviceInfo.androidversion;
              self.location = response.data.result.data[0].location;
            })
            .catch(function (error) {
              console.log(error);
            });
        },
        getFail(service) {

          axios.get('/api', {
              params: {
                action: 'getTraceById',
                apiName: service.apiName,
                status: 'FAIL',
              }
            })
            .then(function (response) {
              self.serviceName = response.data.result.data[0].lifeCycle[0].serviceName;
              // console.log(" responce= " + JSON.stringify(response.data.result));
              self.traceId = response.data.result.data[0].traceId;
              var requestStatus = response.data.result.data[0].status;
              if (requestStatus == 'FAIL') {
                self.status = 'error';
              } else if (requestStatus == 'PASS') {
                self.status = 'success';
              } else {
                self.status = 'success';
              }
              self.model = response.data.result.data[0].deviceInfo.model;
              self.phoneType = response.data.result.data[0].deviceInfo.phoneType;
              self.brand = response.data.result.data[0].deviceInfo.brand;
              self.screenSize = response.data.result.data[0].deviceInfo.screenSize;
              self.androidVersion = response.data.result.data[0].deviceInfo.androidversion;
              self.location = response.data.result.data[0].location;
            })
            .catch(function (error) {
              console.log(error);
            });
        },
        getSlow(service) {

          axios.get('/api', {
              params: {
                action: 'getTraceById',
                apiName: service.apiName,
                status: 'SLOW',
              }
            })
            .then(function (response) {
              self.serviceName = response.data.result.data[0].lifeCycle[0].serviceName;
              // console.log(" responce= " + JSON.stringify(response.data.result));
              self.traceId = response.data.result.data[0].traceId;
              var requestStatus = response.data.result.data[0].status;
              if (requestStatus == 'FAIL') {
                self.status = 'error';
              } else if (requestStatus == 'PASS') {
                self.status = 'success';
              } else {
                self.status = 'success';
              }
              self.model = response.data.result.data[0].deviceInfo.model;
              self.phoneType = response.data.result.data[0].deviceInfo.phoneType;
              self.brand = response.data.result.data[0].deviceInfo.brand;
              self.screenSize = response.data.result.data[0].deviceInfo.screenSize;
              self.androidVersion = response.data.result.data[0].deviceInfo.androidversion;
              self.location = response.data.result.data[0].location;
            })
            .catch(function (error) {
              console.log(error);
            });
        },
        search() {
          if (this.keyword.trim().length === 0) {
            this.isKeywordError = true;
            return;
          }
          this.isKeywordError = false;

          axios.get('/api', {
              params: {
                action: 'getTraceById',
                apiName: this.keyword
              }
            })
            .then(function (response) {
              self.serviceName = response.data.result.data[0].lifeCycle[0].serviceName;
              // console.log(" responce= " + JSON.stringify(response.data.result));
              self.traceId = response.data.result.data[0].traceId;
              var requestStatus = response.data.result.data[0].status;
              if (requestStatus == 'FAIL') {
                self.status = 'error';
              } else if (requestStatus == 'PASS') {
                self.status = 'success';
              } else {
                self.status = 'success';
              }
              self.model = response.data.result.data[0].deviceInfo.model;
              self.phoneType = response.data.result.data[0].deviceInfo.phoneType;
              self.brand = response.data.result.data[0].deviceInfo.brand;
              self.screenSize = response.data.result.data[0].deviceInfo.screenSize;
              self.androidVersion = response.data.result.data[0].deviceInfo.androidversion;
              self.location = response.data.result.data[0].location;
            })
            .catch(function (error) {
              console.log(error);
            });
        }

      }
    });

    var color = Chart.helpers.color;
    var scatterChartData = {

      datasets: [{
          label: 'Failed',
          backgroundColor: '#F82422',
          pointBackgroundColor: '#F82422',
          borderWidth: 1,
          pointRadius: 10,
          pointHoverRadius: 10,
          pointBorderColor: '#F82422',

          data: []
        },
        {
          label: 'Success',
          backgroundColor: '#39f83b',
          pointBackgroundColor: '#39f83b',
          borderWidth: 1,
          pointRadius: 10,
          pointHoverRadius: 10,
          pointBorderColor: '#39f83b',

          data: []
        },
        {
          label: 'Delay',
          backgroundColor: '#f8e315',
          pointBackgroundColor: '#f8e315',
          borderWidth: 1,
          pointRadius: 10,
          pointHoverRadius: 10,
          pointBorderColor: '#f8e315',

          data: []
        }
      ]
    };
    var chartOptions = {
      scales: {
        yAxes: [{
          type: 'linear',
          display: true,
            ticks: {
                beginAtZero: true
            },
          scaleLabel: {
            display: true,
            labelString: 'Request Duration (ms)'
          },
          gridLines: {
            color: '#fff',
            zeroLineColor: '#fff'
          },
        }],
        xAxes: [{
          type: 'time',
          display: true,
          time: {
            unit: 'minute',
            displayFormats: {
              'minute': 'hh:mm a'
            }
          },
          scaleLabel: {
            display: true,
            labelString: 'Request initiation Time'
          },
          gridLines: {
            color: 'rgba(0,0,0,0)',
            lineWidth: 0,
            zeroLineColor: '#fff'
          },
        }],
        pan: {
          enabled: true,
          mode: 'xy'
        },
        zoom: {
          enabled: true,
          mode: 'xy',
        }
      },
      //    tooltips: {
      //      callbacks: {
      //        title: function(items, data) { data.datasets[items[0].datasetIndex].data[items[0].index].traceId },
      //      label: function(item, data) { data.datasets[item.datasetIndex].data[item.index].duration },
      //    cornerRadius: 0,
      //    caretSize: 0,
      //    xPadding: 16,
      //    yPadding: 10,
      //    backgroundColor: 'rgba(0, 150, 100, 0.9)',
      //    titleFontStyle: 'normal',
      //    titleMarginBottom: 15
      //  }
      //  },
      legend: {
        display: true
      },
      responsive: true,
      maintainAspectRatio: false,
    };

    $(document).ready(function () {
      $('#sidebarCollapse').on('click', function () {
        $('#sidebar, #content').toggleClass('active');
      });

      boot();
      var ctx = document.getElementById('livefeed').getContext('2d');
      app.myScatter = Chart.Scatter(ctx, {
        data: scatterChartData,
        options: chartOptions
      });

      Chart.defaults.global.defaultFontColor = 'white';
      Chart.defaults.global.defaultColor = 'rgba(255, 255, 255, 1)';

      //  document.getElementById("livefeed").onclick = function(evt){
      //    var activePoints = window.myScatter.getElementsAtEvent(evt);
      //    var firstPoint = activePoints[0];
      //    value = window.myScatter.data.datasets[firstPoint._datasetIndex].data[firstPoint._index];
      //    console.log(JSON.stringify(value));
      //
      //    axios.get('/api', {
      //      params: {
      //        action: 'getTraceById',
      //        traceId: value.traceId
      //      }
      //    })
      //      .then(function (response) {
      //        app.result.data=response;
      //        console.log(response);
      //      })
      //      .catch(function (error) {
      //        console.log(error);
      //      });
      //  }

    });
    $('.toggle').click(function (e) {
      e.preventDefault();

      var $this = $(this);

      if ($this.next().hasClass('show')) {
        $this.next().removeClass('show');
        $this.next().slideUp(350);
        $this.removeClass('expand').addClass('collapse');
      } else {
        $this.parent().parent().find('li .inner').removeClass('show');
        $this.parent().parent().find('li .inner').slideUp(350);
        $this.next().toggleClass('show');
        $this.next().slideToggle(350);
        $this.removeClass('collapse').addClass('expand');
      }
    });

    var client;
    var boot = function () {
      client = new ActionheroWebsocketClient();

      client.on('connected', function () {
        console.log('connected!')
      })
      client.on('disconnected', function () {
        console.log('disconnected :(')
      })

      client.on('error', function (error) {
        console.log('error', error.stack)
      })
      client.on('reconnect', function () {
        console.log('reconnect')
      })
      client.on('reconnecting', function () {
        console.log('reconnecting')
      })
      client.on('say', function (message) {
        appendMessage(message);
      })

      client.connect(function (error, details) {
        if (error) {
          console.error(error);
        } else {
          client.action('createChatRoom', {
            name: 'lifeFeed'
          }, function (data) {
            client.roomAdd("lifeFeed");
          });
        }
      });
      //      client.roomLeave('lifeFeed');
      //      client.disconnect();

    }

    var statusPass = [];
    var statusFail = [];
    var statusSlow = [];

    var appendMessage = function (message) {

      var trace = JSON.parse(message.message)
      //console.log(JSON.stringify(trace));

      var type = trace.type;

      if (type == 'liveFeed') {

        if (trace.traceId && trace.status) {
          var status = trace.status;

          switch (status) {
            case 'PASS':
              app.myScatter.data.datasets[1].data.push({
                x: trace.requestTime,
                y: trace.duration,
                traceId: trace.traceId,
                traceName: trace.traceName,
                startTime: new Date(trace.startTime),
                endTime: new Date(trace.endTime),
                duration: trace.duration
              })
              if (app.myScatter.data.datasets[1].data.length > 50) {
                app.myScatter.data.datasets[1].data = app.myScatter.data.datasets[1].data.splice(1);
              }
              break;
            case 'FAIL':
              app.myScatter.data.datasets[0].data.push({
                x: trace.requestTime,
                y: trace.duration,
                traceId: trace.traceId,
                traceName: trace.traceName,
                startTime: new Date(trace.startTime),
                endTime: new Date(trace.endTime),
                duration: trace.duration
              })
              if (app.myScatter.data.datasets[0].data.length > 50) {
                app.myScatter.data.datasets[0].data = app.myScatter.data.datasets[0].data.splice(1);
              }
              break;
            case 'SLOW':
              app.myScatter.data.datasets[2].data.push({
                x: trace.requestTime,
                y: trace.duration,
                traceId: trace.traceId,
                traceName: trace.traceName,
                startTime: new Date(trace.startTime),
                endTime: new Date(trace.endTime),
                duration: trace.duration
              })
              if (app.myScatter.data.datasets[2].data.length > 50) {
                app.myScatter.data.datasets[2].data = app.myScatter.data.datasets[2].data.splice(1);
              }
              break;
          }
          //      console.log('pass:' + JSON.stringify(statusPass));
          //      console.log('fail:' + JSON.stringify(statusFail));
          //      console.log('slow:' + JSON.stringify(statusSlow));
          //console.log(window.myScatter.data.datasets[0].data);
          app.myScatter.update();

        }
      } else {
        if (trace.data) {
          //console.log('pass:' + JSON.stringify(trace.data));
          app.api = trace.data;
          app.myScatter.update();

        }
      }
    }
  </script>
</body>

</html>